<%inherit file="base.html"/>
<%def name="head()">
<script src="/static/js/highcharts.js"></script>
<script src="/static/js/charttheme.js"></script>
<script src="/static/js/exporting.js"></script>
<script>
function busy(flag) {
    if (flag) {
        $("#loading").show();
        $("#inbox").html("")
        $("#inbox").hide();
    } else {
        $("#loading").hide();
        $("#inbox").show();
    }
}

var msgstat_options = {
    credits : {enabled:false},
    chart: {type: 'areaspline',renderTo: 'msgstat-chart',height:300},
    title: {text: '最近15分钟的消息统计'},
    xAxis: {type: 'datetime',tickInterval : 60*1000},
    yAxis: {title: {text: '消息量'},
        labels: {formatter: function() {return this.value;}}              
    },
    tooltip: {shared: true},
    legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                x: 150,
                y: 100,
                floating: true,
                borderWidth: 1,
                backgroundColor: '#FFFFFF'
            },  
    plotOptions: {areaspline: {
        marker: {enabled: false,symbol: 'circle',radius: 2,states: {hover: {enabled: true}}},
        fillOpacity: 0.4
    }},           
    series: [{},{}]
};

var msgstat_chart;
function updateMsgStat(){
    if(!msgstat_chart){
        msgstat_chart = new Highcharts.Chart(msgstat_options);
    }
    $.get("/admin/dashboard/msgstat", function (data) {
        console.log(data)
        for (p in data){
            $("#"+p).html(data[p])
        }
        var auth_stat = {name:'认证消息',data:data.auth_stat};
        var acct_stat = {name:'计费消息',data:data.acct_stat};
        console.log(auth_stat);
        console.log(acct_stat);
        msgstat_chart.series[0].update(auth_stat) ;
        msgstat_chart.series[1].update(acct_stat) ;
    },"json");
    setTimeout("updateMsgStat()", 15000);
}

function update() {
    busy(true);
    $.post("/admin/dashboard/update", {_xsrf: '${handler.xsrf_token}'}, function (data) {
        $("#status_line").html(data.value)
        busy(false);
    },"json");
}


function restart() {
    busy(true);
    $.ajax({
        url: '/admin/dashboard/restart',
        data:{_xsrf: '${handler.xsrf_token}'},
        dataType:"json",
        type: 'POST',
        timeout: 9000,
        error: function (xhr, textStatus) {
            busy(false);
            update()
        },
    });
    setTimeout("update()", 9000);
}

$(document).ready(function () {
    Highcharts.setOptions({global: {useUTC: false}});
    $("#loading").hide();
    $("#inbox").hide();

    $("#restart").click(function () {
        restart();
    });

    $("#refresh").click(function () {
        update()
    });
    updateMsgStat();
});

</script>
</%def>


<%def name="body()">
<section class="content">
    <div class="box box-primary">
        <div class="box-header">
            <i class="fa fa-dashboard"></i>
            <h3 class="box-title">控制面板</h3>
        </div>
        <div class="box-body">
            <div class="container">
            <table class="table table-hover">
                <thead>
                <tr>
                    <th colspan="4"> <i class="fa fa-user"></i> 当前登录管理员</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>登录管理员</td>
                    <td>${current_user.username}</td>
                    <td>登录时间</td>
                    <td>${current_user.login_time}</td>
                </tr>
                <tr>
                    <td>登录IP地址</td>
                    <td>${current_user.ipaddr or ''}</td>
                    <td>系统版本</td>
                    <td>${sys_version or '1.0'}</td>
                </tr>
                </tbody>
                <thead>
                <tr>
                    <th colspan="4"> <i class="fa fa-laptop"></i> 管理服务信息</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>监听地址</td>
                    <td>${config.admin.host}</td>
                    <td>WEB管理端口</td>
                    <td>${config.admin.port}</td>                    
                </tr>
                </tbody>
                <thead>
                <tr>
                    <th colspan="4"><i class="fa fa-laptop"></i>  Radius 服务信息</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>监听地址</td>
                    <td>${config.radiusd.host}</td>
                    <td>认证端口/记账端口</td>
                    <td>${config.radiusd.auth_port}／${config.radiusd.acct_port}</td>                    
                </tr>
                </tbody>

            </table>

            <hr>
            <div id="loading" style="display: none;"><img style="max-height: 90px;width: auto;"
                                                          src="/static/img/loading.gif"></div>
            <div id="inbox" class="text-info" style="height:120px;overflow:auto"></div>

            
        </div>
    </div>
        </div>

    <div class="box box-default">
        <div class="box-header">
            <i class="fa fa-area-chart"></i>
            <h3 class="box-title">消息统计</h3>
            <div class="bar pull-right">
                        <a href="javascript:updateMsgStat();">刷新数据</a>
            </div>
        </div>
        <div class="box-body">
            <div class="container">
                <div class="panel-body">
                    <div class="container center" id="msgstat-chart"> </div>
                    <br>
                    <div id="msgstat_list">
                    <ul class="list-group col-md-6">
                        <li class="list-group-item">
                            <span class="badge" id="auth_all"></span>
                            认证消息总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="auth_accept"></span>
                            认证成功总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="auth_reject"></span>
                            认证拒绝总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="auth_drop"></span>
                            认证丢弃总数
                        </li>
                    </ul>
                    <ul class="list-group col-md-6">
                        <li class="list-group-item">
                            <span class="badge" id="acct_all"></span>
                            记账消息总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="acct_start"></span>
                            记账上线总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="acct_update"></span>
                            记账更新总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="acct_stop"></span>
                            记账下线总数
                        </li>
                        <li class="list-group-item">
                            <span class="badge" id="acct_drop"></span>
                            记账丢弃总数
                        </li>
                    </ul>
                    </div>
                </div>
            </div>
        </div>
</section>
</%def>

